name: macOS Web SSH Access sonet
on:
  workflow_dispatch:
    inputs:
      session_password:
        description: 'Web Terminal Password'
        required: false
        default: 'github2024'
        type: string

jobs:
  macos-web-ssh:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get Public IP and Setup Tools
      run: |
        # Get public IP address for localtunnel
        PUBLIC_IP=$(curl -s https://ipinfo.io/ip)
        echo "ðŸŒ Runner Public IP: $PUBLIC_IP"
        echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
        
        # Install required packages
        brew install ttyd node
        npm install -g localtunnel
        
        echo "âœ… Basic tools installed successfully"
        
    - name: Start Web Terminal
      run: |
        # Start ttyd web terminal on port 8080
        ttyd \
          --port 8080 \
          --credential "admin:${{ github.event.inputs.session_password }}" \
          /bin/bash &
        
        echo "ðŸŒ Web terminal started on port 8080"
        sleep 5
        
    - name: Setup Localtunnel
      run: |
        echo "ðŸ“¡ Starting localtunnel..."
        npx localtunnel --port 8080 --subdomain github-macos-$(date +%s) > localtunnel.log 2>&1 &
        sleep 15
        
        LOCALTUNNEL_URL=$(grep -o 'https://[^[:space:]]*' localtunnel.log | head -1)
        
        if [ ! -z "$LOCALTUNNEL_URL" ]; then
            echo "$LOCALTUNNEL_URL" > localtunnel_url.txt
            echo "âœ… Localtunnel active: $LOCALTUNNEL_URL"
        else
            echo "âš ï¸  Localtunnel failed to start"
        fi
        
    - name: Setup Serveo Tunnel
      run: |
        echo "ðŸ”„ Starting serveo.net tunnel..."
        timeout 20s ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -R 80:localhost:8080 serveo.net > serveo.log 2>&1 &
        sleep 15
        
        SERVEO_URL=$(grep -o 'https://[^[:space:]]*\.serveo\.net' serveo.log | head -1 2>/dev/null || echo "")
        
        if [ ! -z "$SERVEO_URL" ]; then
            echo "$SERVEO_URL" > serveo_url.txt
            echo "âœ… Serveo tunnel active: $SERVEO_URL"
        else
            echo "âš ï¸  Serveo tunnel failed"
        fi
        
    - name: Setup Cloudflare Tunnel
      run: |
        echo "â˜ï¸  Installing and starting Cloudflare tunnel..."
        brew install cloudflared
        
        # Start cloudflared tunnel
        cloudflared tunnel --url http://localhost:8080 > cloudflare.log 2>&1 &
        sleep 20
        
        # Extract cloudflare URL
        CF_URL=$(grep -o 'https://[^[:space:]]*\.trycloudflare\.com' cloudflare.log | head -1)
        
        if [ ! -z "$CF_URL" ]; then
            echo "$CF_URL" > cloudflare_url.txt
            echo "âœ… Cloudflare tunnel active: $CF_URL"
        else
            echo "âš ï¸  Cloudflare tunnel failed"
        fi
        
    - name: Setup Bore Tunnel
      run: |
        echo "ðŸš€ Installing bore via Homebrew..."
        
        # Try to install bore-cli
        if brew install bore-cli; then
            echo "âœ… Bore installed successfully"
            
            # Start bore tunnel
            bore local 8080 --to bore.pub > bore.log 2>&1 &
            sleep 15
            
            # Extract bore URL
            BORE_URL=$(grep -o 'bore\.pub:[0-9]*' bore.log | head -1)
            
            if [ ! -z "$BORE_URL" ]; then
                echo "http://$BORE_URL" > bore_url.txt
                echo "âœ… Bore tunnel active: http://$BORE_URL"
            else
                echo "âš ï¸  Bore tunnel failed to get URL"
            fi
        else
            echo "âš ï¸  Bore installation failed"
        fi
        
    - name: Display All Access Methods
      run: |
        echo ""
        echo "ðŸŽ‰ macOS Web Terminal is ready!"
        echo "âš¡ System: macOS $(sw_vers -productVersion) ($(uname -m))"
        echo "ðŸ’¾ RAM: $(sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}') | CPU: $(sysctl -n hw.ncpu) cores"
        echo "ðŸŒ Public IP: $PUBLIC_IP"
        echo ""
        echo "ðŸ”— AVAILABLE ACCESS METHODS:"
        echo "================================"
        
        # Method 1: Cloudflare (Best option)
        if [ -f cloudflare_url.txt ] && [ -s cloudflare_url.txt ]; then
            CF_URL=$(cat cloudflare_url.txt)
            echo "ðŸ¥‡ METHOD 1 - Cloudflare Tunnel (RECOMMENDED):"
            echo "   URL: $CF_URL"
            echo "   ðŸ‘¤ Login: admin / ${{ github.event.inputs.session_password }}"
            echo "   âœ… No tunnel password required!"
            echo "   ðŸ–¥ï¸  Direct terminal: $CF_URL/terminal"
            echo ""
        fi
        
        # Method 2: Serveo
        if [ -f serveo_url.txt ] && [ -s serveo_url.txt ]; then
            SERVEO_URL=$(cat serveo_url.txt)
            echo "ðŸ¥ˆ METHOD 2 - Serveo.net:"
            echo "   URL: $SERVEO_URL"
            echo "   ðŸ‘¤ Login: admin / ${{ github.event.inputs.session_password }}"
            echo "   âœ… No tunnel password required!"
            echo "   ðŸ–¥ï¸  Direct terminal: $SERVEO_URL/terminal"
            echo ""
        fi
        
        # Method 3: Bore
        if [ -f bore_url.txt ] && [ -s bore_url.txt ]; then
            BORE_URL=$(cat bore_url.txt)
            echo "ðŸ¥‰ METHOD 3 - Bore.pub:"
            echo "   URL: $BORE_URL"
            echo "   ðŸ‘¤ Login: admin / ${{ github.event.inputs.session_password }}"
            echo "   âœ… No tunnel password required!"
            echo "   ðŸ–¥ï¸  Direct terminal: $BORE_URL/terminal"
            echo ""
        fi
        
        # Method 4: Localtunnel (requires IP)
        if [ -f localtunnel_url.txt ] && [ -s localtunnel_url.txt ]; then
            LOCALTUNNEL_URL=$(cat localtunnel_url.txt)
            echo "ðŸ” METHOD 4 - Localtunnel (Needs IP password):"
            echo "   URL: $LOCALTUNNEL_URL"
            echo "   ðŸ”‘ Tunnel Password: $PUBLIC_IP"
            echo "   ðŸ‘¤ Terminal Login: admin / ${{ github.event.inputs.session_password }}"
            echo "   ðŸ–¥ï¸  Direct terminal: $LOCALTUNNEL_URL/terminal"
            echo ""
        fi
        
    - name: Create Usage Instructions
      run: |
        echo "ðŸ“‹ QUICK START GUIDE:"
        echo "===================="
        echo "1. ðŸŒ Open any of the URLs above in your web browser"
        echo "2. ðŸ” For Localtunnel: Enter IP password if prompted"
        echo "3. ðŸ‘¤ Login with: admin / ${{ github.event.inputs.session_password }}"
        echo "4. ðŸ–¥ï¸  Start using your macOS terminal!"
        echo ""
        echo "ðŸ’¡ USEFUL COMMANDS:"
        echo "â€¢ System info: neofetch"
        echo "â€¢ Install packages: brew install [package]"
        echo "â€¢ File operations: ls, cd, mkdir, etc."
        echo "â€¢ Git operations: git clone, git pull, etc."
        echo "â€¢ Python: python3 --version"
        echo "â€¢ Node.js: node --version"
        echo ""
        echo "ðŸ› ï¸  DEVELOPMENT TOOLS AVAILABLE:"
        echo "â€¢ Homebrew package manager"
        echo "â€¢ Git version control"
        echo "â€¢ Python 3"
        echo "â€¢ Node.js & npm"
        echo "â€¢ Xcode command line tools"
        echo "â€¢ Text editors: vim, nano"
        
    - name: Monitor and Keep Alive
      run: |
        echo ""
        echo "â° Session will remain active for up to 6 hours"
        echo "ðŸ’¡ Use 'sudo shutdown -h now' in terminal to end early"
        echo "ðŸ”„ Auto-monitoring services every 5 minutes..."
        echo ""
        
        # Monitor and restart services if needed
        while true; do
            # Check ttyd
            if ! pgrep ttyd > /dev/null; then
                echo "ðŸ”„ Restarting web terminal..."
                ttyd --port 8080 --credential "admin:${{ github.event.inputs.session_password }}" /bin/bash &
                sleep 5
            fi
            
            # Check tunnels and restart if needed
            if ! pgrep -f localtunnel > /dev/null; then
                echo "ðŸ”„ Restarting localtunnel..."
                npx localtunnel --port 8080 > /dev/null 2>&1 &
            fi
            
            if ! pgrep -f cloudflared > /dev/null; then
                echo "ðŸ”„ Restarting cloudflare tunnel..."
                cloudflared tunnel --url http://localhost:8080 > /dev/null 2>&1 &
            fi
            
            echo "$(date): âœ… All services running | IP: $PUBLIC_IP"
            sleep 300  # Check every 5 minutes
        done
