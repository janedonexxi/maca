name: Windows VNC Desktop (Web Access) 
on:
  workflow_dispatch:
    inputs:
      vnc_password:
        description: 'VNC ÅŸifreniz'
        required: true
        default: 'github'
        type: string

jobs:
  windows-desktop:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: 1. OrtamÄ± ve UygulamalarÄ± YÃ¼kle
        run: |
          Write-Host "ğŸ“¦ Chocolatey ile uygulamalar yÃ¼kleniyor..." -ForegroundColor Green
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install tightvnc googlechrome firefox vscode cloudflared -y

      - name: 2. TightVNC Sunucusunu YapÄ±landÄ±r ve BaÅŸlat
        run: |
          Write-Host "ğŸ”§ VNC Sunucusu yapÄ±landÄ±rÄ±lÄ±yor..." -ForegroundColor Cyan
          
          # VNC ÅŸifresini ve diÄŸer ayarlarÄ± registry'e yaz. Bu en gÃ¼venilir yÃ¶ntemdir.
          $regPath = "HKLM:\SOFTWARE\TightVNC\Server"
          New-Item -Path $regPath -Force | Out-Null
          Set-ItemProperty -Path $regPath -Name "Password" -Value (echo "${{ github.event.inputs.vnc_password }}" | C:\"Program Files"\TightVNC\vncpasswd.exe -e)
          Set-ItemProperty -Path $regPath -Name "PasswordViewOnly" -Value (echo "${{ github.event.inputs.vnc_password }}" | C:\"Program Files"\TightVNC\vncpasswd.exe -e)
          Set-ItemProperty -Path $regPath -Name "UseVncAuthentication" -Value 1
          Set-ItemProperty -Path $regPath -Name "AcceptHttpConnections" -Value 0 # noVNC kullanacaÄŸÄ±mÄ±z iÃ§in dahili web sunucusuna gerek yok
          Set-ItemProperty -Path $regPath -Name "RfbPort" -Value 5900
          
          # VNC Servisini yeniden baÅŸlatarak ayarlarÄ±n geÃ§erli olmasÄ±nÄ± saÄŸla
          Restart-Service -Name "tvnserver" -Force
          Write-Host "âœ… VNC Sunucusu 5900 portunda baÅŸlatÄ±ldÄ±." -ForegroundColor Green

      - name: 3. noVNC Web ArayÃ¼zÃ¼nÃ¼ Ayarla
        run: |
          Write-Host "ğŸŒ noVNC ve Websocket proxy ayarlanÄ±yor..." -ForegroundColor Cyan
          
          # Gerekli Python paketini ve noVNC'yi indir
          pip install websockify
          git clone https://github.com/novnc/noVNC.git C:\noVNC
          
          # noVNC'yi arkaplanda Ã§alÄ±ÅŸtÄ±rmak iÃ§in PowerShell'in 'Start-Job' Ã¶zelliÄŸini kullan.
          # Bu, ayrÄ± bir .bat dosyasÄ± oluÅŸturmaktan daha temizdir.
          $ScriptBlock = {
              & python -m websockify --web C:\noVNC 6080 localhost:5900
          }
          Start-Job -ScriptBlock $ScriptBlock
          
          Start-Sleep -Seconds 5
          Write-Host "âœ… noVNC web arayÃ¼zÃ¼ 6080 portunda hazÄ±r." -ForegroundColor Green

      - name: 4. Herkese AÃ§Ä±k EriÅŸim TÃ¼neli OluÅŸtur (Cloudflare)
        run: |
          Write-Host "ğŸš€ Cloudflare Tunnel ile genel eriÅŸim saÄŸlanÄ±yor..." -ForegroundColor Cyan
          
          # Cloudflare tÃ¼nelini baÅŸlat ve loglarÄ± bir dosyaya yaz
          Start-Process -FilePath "cloudflared.exe" -ArgumentList "tunnel --url http://localhost:6080 --no-autoupdate" -RedirectStandardOutput "C:\cf.log" -RedirectStandardError "C:\cf.log" -NoNewWindow
          
          # TÃ¼nelin oluÅŸmasÄ±nÄ± ve URL'nin log dosyasÄ±na yazÄ±lmasÄ±nÄ± bekle
          Write-Host "URL'nin oluÅŸmasÄ± iÃ§in 20 saniye bekleniyor..."
          Start-Sleep -Seconds 20
          
          # Log dosyasÄ±ndan tÃ¼nel URL'sini al
          $cf_url = Get-Content C:\cf.log | Select-String -Pattern "https://.*trycloudflare.com" | ForEach-Object { $_.Matches[0].Value } | Select-Object -First 1
          
          if ($cf_url) {
              echo "CLOUDFLARE_URL=$cf_url" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              Write-Host "âœ… Cloudflare TÃ¼neli HazÄ±r!" -ForegroundColor Green
          } else {
              Write-Host "âŒ HATA: Cloudflare tÃ¼nel URL'si alÄ±namadÄ±. Loglar:" -ForegroundColor Red
              Get-Content C:\cf.log
              exit 1
          }

      - name: 5. EriÅŸim Bilgilerini GÃ¶rÃ¼ntÃ¼le
        run: |
          echo "===================================================================="
          echo "ğŸ‰ Windows VNC MasaÃ¼stÃ¼nÃ¼z HazÄ±r!"
          echo "===================================================================="
          echo ""
          echo "ğŸŒ Web TarayÄ±cÄ±nÄ±zdan BaÄŸlanÄ±n:"
          echo "   MasaÃ¼stÃ¼: ${{ env.CLOUDFLARE_URL }}"
          echo ""
          echo "ğŸ” VNC Åifreniz: ${{ github.event.inputs.vnc_password }}"
          echo ""
          echo "ğŸ’¡ Not: Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda noVNC arayÃ¼zÃ¼nde 'Connect' butonuna basÄ±n ve ÅŸifrenizi girin."
          echo "===================================================================="
        
      - name: 6. Oturumu AÃ§Ä±k Tut
        run: |
          Write-Host "â° Oturum yaklaÅŸÄ±k 6 saat boyunca aÃ§Ä±k kalacak." -ForegroundColor Green
          while ($true) {
            Start-Sleep -Seconds 60
          }
