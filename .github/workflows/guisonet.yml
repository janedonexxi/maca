name: macOS VNC Desktop (Experimental TCC Edit)
on:
  workflow_dispatch:
    inputs:
      vnc_password:
        description: 'VNC şifreniz (en fazla 8 karakter)'
        required: true
        default: 'github'
        type: string

jobs:
  macos-desktop:
    runs-on: macos-latest
    timeout-minutes: 350

    steps:
      - name: 1. Ortamı Hazırla
        run: |
          echo "✅ Ortam hazırlanıyor..."
          brew install --cask firefox visual-studio-code
          brew install cloudflared ttyd nginx

      - name: 2. [DENEYSEL] Ekran Kaydı İznini TCC Veritabanına Ekle
        run: |
          echo "🔬 [DENEYSEL] VNC sunucusu için Ekran Kaydı izni eklenmeye çalışılıyor..."
          
          # Bu komutlar, macOS'un güvenlik veritabanına doğrudan yazmaya çalışır.
          # Sistem Bütünlüğü Koruması (SIP) nedeniyle başarısız olabilir.
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','com.apple.ARDAgent',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,$(date +%s));" \
            || echo "TCC veritabanı güncellemesi başarısız oldu (beklenen bir durum olabilir)."
            
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','com.apple.remoteDesktopAgent',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,$(date +%s));" \
            || echo "TCC veritabanı güncellemesi (2. deneme) başarısız oldu."

          echo "TCC veritabanı düzenleme denemesi tamamlandı."
          sleep 2

      - name: 3. macOS Dahili VNC Sunucusunu Etkinleştir
        run: |
          echo "🔒 macOS Ekran Paylaşımı (VNC) etkinleştiriliyor..."
          
          # Önce mevcut servisleri durdur
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -stop
          
          # VNC sunucusunu başlat
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -configure -allowAccessFor -allUsers \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw ${{ github.event.inputs.vnc_password }} \
            -restart -agent -privs -all

          echo "VNC servisinin başlaması için 10 saniye bekleniyor..."
          sleep 10
          
          if lsof -i :5900; then
            echo "✅ VNC sunucusu 5900 portunda başarıyla başlatıldı."
          else
            echo "❌ HATA: VNC sunucusu başlatılamadı."
            exit 1
          fi

      # Kalan adımlar (4, 5, 6, 7) öncekiyle aynı...
      - name: 4. noVNC Web Arayüzünü ve Proxy'yi Ayarla
        run: |
          echo "🌐 noVNC ve Web Proxy ayarları yapılıyor..."
          git clone https://github.com/novnc/noVNC.git /tmp/noVNC
          /tmp/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 > /tmp/novnc.log 2>&1 &
          ttyd --port 8080 bash > /tmp/ttyd.log 2>&1 &
          
          cat > /tmp/nginx.conf << 'END'
          events {}
          http {
              server {
                  listen 8090;
                  location / {
                      proxy_pass http://127.0.0.1:6080/;
                      proxy_http_version 1.1;
                      proxy_set_header Upgrade $http_upgrade;
                      proxy_set_header Connection "upgrade";
                  }
                  location /terminal {
                      proxy_pass http://127.0.0.1:8080/;
                      proxy_http_version 1.1;
                      proxy_set_header Upgrade $http_upgrade;
                      proxy_set_header Connection "upgrade";
                  }
              }
          }
          END
          
          nginx -c /tmp/nginx.conf
          echo "✅ Web servisleri (noVNC, ttyd, Nginx) çalışıyor."

      - name: 5. Herkese Açık Erişim Tüneli Oluştur (Cloudflare)
        run: |
          echo "🚀 Cloudflare Tunnel ile genel erişim sağlanıyor..."
          cloudflared tunnel --url http://localhost:8090 > /tmp/cloudflared.log 2>&1 &
          sleep 15
          
          CF_URL=$(grep -o 'https://[^[:space:]]*.trycloudflare.com' /tmp/cloudflared.log | head -n 1)
          if [ -z "$CF_URL" ]; then
            echo "❌ HATA: Cloudflare tünel URL'si alınamadı."
            cat /tmp/cloudflared.log
            exit 1
          fi
          
          echo "CLOUDFLARE_URL=${CF_URL}" >> $GITHUB_ENV
          echo "✅ Cloudflare Tüneli hazır."

      - name: 6. Erişim Bilgilerini Görüntüle
        run: |
          echo "===================================================================="
          echo "🎉 macOS VNC Masaüstünüz Hazır!"
          echo "===================================================================="
          echo "🌐 Web Tarayıcınızdan Bağlanın:"
          echo "   Masaüstü: ${{ env.CLOUDFLARE_URL }}"
          echo "   Terminal: ${{ env.CLOUDFLARE_URL }}/terminal"
          echo "🔐 VNC Şifreniz: ${{ github.event.inputs.vnc_password }}"
          echo "===================================================================="
          
      - name: 7. Oturumu Açık Tut
        run: |
          echo "⏰ Oturum yaklaşık 6 saat boyunca açık kalacak."
          tail -f /dev/null
