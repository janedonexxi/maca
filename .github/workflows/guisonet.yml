name: macOS VNC Desktop (Alternative)
on:
  workflow_dispatch:
    inputs:
      vnc_password:
        description: 'VNC ÅŸifreniz (en fazla 8 karakter)'
        required: true
        default: 'github'
        type: string

jobs:
  macos-desktop:
    runs-on: macos-latest
    timeout-minutes: 350

    steps:
      - name: 1. OrtamÄ± HazÄ±rla
        run: |
          echo "âœ… Ortam hazÄ±rlanÄ±yor..."
          # X11 ve sanal masaÃ¼stÃ¼ iÃ§in gerekli araÃ§lar
          brew install --cask xquartz
          brew install tigervnc fluxbox
          
          # DiÄŸer araÃ§lar
          brew install --cask firefox visual-studio-code
          brew install cloudflared ttyd nginx

      - name: 2. TigerVNC Sunucusunu Kur
        run: |
          echo "ğŸ… TigerVNC sunucusu ve sanal masaÃ¼stÃ¼ kuruluyor..."
          
          # VNC ÅŸifre dosyasÄ±nÄ± oluÅŸtur
          echo "${{ github.event.inputs.vnc_password }}" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # VNC baÅŸlangÄ±Ã§ betiÄŸini oluÅŸtur (Fluxbox masaÃ¼stÃ¼nÃ¼ baÅŸlatacak)
          cat > ~/.vnc/xstartup << 'EOF'
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          export XKL_XMODMAP_DISABLE=1
          [ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
          [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
          xsetroot -solid grey
          vncconfig -iconic &
          exec fluxbox
          EOF
          chmod +x ~/.vnc/xstartup
          
          # VNC sunucusunu baÅŸlat (Port 5901)
          vncserver :1 -geometry 1920x1080 -depth 24 -localhost no
          sleep 5

      - name: 3. noVNC Web ArayÃ¼zÃ¼nÃ¼ ve Proxy'yi Ayarla
        run: |
          echo "ğŸŒ noVNC ve Web Proxy ayarlarÄ± yapÄ±lÄ±yor..."
          git clone https://github.com/novnc/noVNC.git /tmp/noVNC
          
          # noVNC'yi TigerVNC portuna (5901) baÄŸla
          /tmp/noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 6080 > /tmp/novnc.log 2>&1 &
          ttyd --port 8080 bash > /tmp/ttyd.log 2>&1 &
          
          cat > /tmp/nginx.conf << 'END'
          events {}
          http {
              server {
                  listen 8090;
                  location / {
                      proxy_pass http://127.0.0.1:6080/;
                      proxy_http_version 1.1;
                      proxy_set_header Upgrade $http_upgrade;
                      proxy_set_header Connection "upgrade";
                  }
                  location /terminal {
                      proxy_pass http://127.0.0.1:8080/;
                      proxy_http_version 1.1;
                      proxy_set_header Upgrade $http_upgrade;
                      proxy_set_header Connection "upgrade";
                  }
              }
          }
          END
          
          nginx -c /tmp/nginx.conf
          echo "âœ… Web servisleri (noVNC, ttyd, Nginx) Ã§alÄ±ÅŸÄ±yor."

      - name: 4. Herkese AÃ§Ä±k EriÅŸim TÃ¼neli OluÅŸtur (Cloudflare)
        run: |
          echo "ğŸš€ Cloudflare Tunnel ile genel eriÅŸim saÄŸlanÄ±yor..."
          cloudflared tunnel --url http://localhost:8090 > /tmp/cloudflared.log 2>&1 &
          sleep 15
          
          CF_URL=$(grep -o 'https://[^[:space:]]*.trycloudflare.com' /tmp/cloudflared.log | head -n 1)
          if [ -z "$CF_URL" ]; then
            echo "âŒ HATA: Cloudflare tÃ¼nel URL'si alÄ±namadÄ±."
            cat /tmp/cloudflared.log
            exit 1
          fi
          
          echo "CLOUDFLARE_URL=${CF_URL}" >> $GITHUB_ENV
          echo "âœ… Cloudflare TÃ¼neli hazÄ±r."

      - name: 5. EriÅŸim Bilgilerini GÃ¶rÃ¼ntÃ¼le
        run: |
          echo "===================================================================="
          echo "ğŸ‰ macOS VNC MasaÃ¼stÃ¼nÃ¼z HazÄ±r! (TigerVNC + Fluxbox)"
          echo "===================================================================="
          echo "ğŸŒ Web TarayÄ±cÄ±nÄ±zdan BaÄŸlanÄ±n:"
          echo "   MasaÃ¼stÃ¼: ${{ env.CLOUDFLARE_URL }}"
          echo "   Terminal: ${{ env.CLOUDFLARE_URL }}/terminal"
          echo "ğŸ” VNC Åifreniz: ${{ github.event.inputs.vnc_password }}"
          echo "âš ï¸ Not: Bu gerÃ§ek macOS arayÃ¼zÃ¼ deÄŸil, basit bir sanal masaÃ¼stÃ¼dÃ¼r."
          echo "===================================================================="
          
      - name: 6. Oturumu AÃ§Ä±k Tut
        run: |
          echo "â° Oturum yaklaÅŸÄ±k 6 saat boyunca aÃ§Ä±k kalacak."
          tail -f /dev/null
