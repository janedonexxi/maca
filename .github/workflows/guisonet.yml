name: macOS VNC Desktop gem
on:
  workflow_dispatch:
    inputs:
      vnc_password:
        description: 'VNC ÅŸifreniz (en fazla 8 karakter)'
        required: true
        default: 'github'
        type: string

jobs:
  macos-desktop:
    runs-on: macos-latest
    timeout-minutes: 350 # GitHub'Ä±n maksimum limiti 360 dakikadÄ±r.

    steps:
      - name: 1. OrtamÄ± HazÄ±rla
        run: |
          echo "âœ… Ortam hazÄ±rlanÄ±yor..."
          # Gerekli araÃ§larÄ± Homebrew ile yÃ¼kle
          brew install --cask firefox visual-studio-code
          brew install cloudflared ttyd nginx

      - name: 2. macOS Dahili VNC Sunucusunu EtkinleÅŸtir
        run: |
          echo "ğŸ”’ macOS Ekran PaylaÅŸÄ±mÄ± (VNC) etkinleÅŸtiriliyor..."
          
          # VNC ÅŸifresini ayarla ve sunucuyu baÅŸlat. Bu, macOS'un en gÃ¼venilir yÃ¶ntemidir.
          # Bu komut, tÃ¼m kullanÄ±cÄ±larÄ±n belirtilen ÅŸifre ile baÄŸlanmasÄ±na izin verir.
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -configure -allowAccessFor -allUsers \
            -configure -clientopts -setvnclegacy -vnclegacy yes \
            -configure -clientopts -setvncpw -vncpw ${{ github.event.inputs.vnc_password }} \
            -restart -agent -privs -all

          # VNC sunucusunun port 5900'de baÅŸladÄ±ÄŸÄ±ndan emin olmak iÃ§in kÄ±sa bir bekleme
          sleep 5
          
          # VNC sunucusunun Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± kontrol et
          if lsof -i :5900; then
            echo "âœ… VNC sunucusu 5900 portunda baÅŸarÄ±yla baÅŸlatÄ±ldÄ±."
          else
            echo "âŒ HATA: VNC sunucusu baÅŸlatÄ±lamadÄ±."
            exit 1
          fi

      - name: 3. noVNC Web ArayÃ¼zÃ¼nÃ¼ ve Proxy'yi Ayarla
        run: |
          echo "ğŸŒ noVNC ve Web Proxy ayarlarÄ± yapÄ±lÄ±yor..."
          
          # noVNC'yi indir
          git clone https://github.com/novnc/noVNC.git /tmp/noVNC
          
          # noVNC'nin VNC sunucusuna (localhost:5900) baÄŸlanmasÄ±nÄ± saÄŸlayan websockify'Ä± baÅŸlat
          # Python'un varsayÄ±lan olarak yÃ¼klÃ¼ geldiÄŸi macOS runner'da websockify'Ä± doÄŸrudan Ã§alÄ±ÅŸtÄ±rabiliriz.
          /tmp/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 > /tmp/novnc.log 2>&1 &
          
          # Web tabanlÄ± terminal (ttyd) baÅŸlat
          ttyd --port 8080 bash > /tmp/ttyd.log 2>&1 &
          
          # Gelen istekleri doÄŸru servislere yÃ¶nlendirecek olan Nginx proxy'sini yapÄ±landÄ±r
          cat > /tmp/nginx.conf << 'END'
          events {}
          http {
              server {
                  listen 8090;
                  
                  # / URL'si noVNC web arayÃ¼zÃ¼ne gider
                  location / {
                      proxy_pass http://127.0.0.1:6080/;
                      proxy_http_version 1.1;
                      proxy_set_header Upgrade $http_upgrade;
                      proxy_set_header Connection "upgrade";
                  }

                  # /terminal URL'si web terminaline gider
                  location /terminal {
                      proxy_pass http://127.0.0.1:8080/;
                      proxy_http_version 1.1;
                      proxy_set_header Upgrade $http_upgrade;
                      proxy_set_header Connection "upgrade";
                  }
              }
          }
          END
          # Nginx'i baÅŸlat
          nginx -c /tmp/nginx.conf
          
          echo "âœ… Web servisleri (noVNC, ttyd, Nginx) Ã§alÄ±ÅŸÄ±yor."

      - name: 4. Herkese AÃ§Ä±k EriÅŸim TÃ¼neli OluÅŸtur (Cloudflare)
        run: |
          echo "ğŸš€ Cloudflare Tunnel ile genel eriÅŸim saÄŸlanÄ±yor..."
          
          # Nginx proxy'mizi (port 8090) internete aÃ§mak iÃ§in Cloudflare TÃ¼neli baÅŸlat
          cloudflared tunnel --url http://localhost:8090 > /tmp/cloudflared.log 2>&1 &
          
          # TÃ¼nelin oluÅŸmasÄ± ve URL'nin log dosyasÄ±na yazÄ±lmasÄ± iÃ§in bekle
          sleep 15
          
          # OluÅŸturulan URL'yi yakala ve sonraki adÄ±mlarda kullanmak iÃ§in GITHUB_ENV'e yaz
          CF_URL=$(grep -o 'https://[^[:space:]]*.trycloudflare.com' /tmp/cloudflared.log | head -n 1)
          
          if [ -z "$CF_URL" ]; then
              echo "âŒ HATA: Cloudflare tÃ¼nel URL'si alÄ±namadÄ±. LoglarÄ± kontrol edin:"
              cat /tmp/cloudflared.log
              exit 1
          fi
          
          echo "CLOUDFLARE_URL=${CF_URL}" >> $GITHUB_ENV
          echo "âœ… Cloudflare TÃ¼neli hazÄ±r."

      - name: 5. EriÅŸim Bilgilerini GÃ¶rÃ¼ntÃ¼le
        run: |
          echo "===================================================================="
          echo "ğŸ‰ macOS VNC MasaÃ¼stÃ¼nÃ¼z HazÄ±r!"
          echo "===================================================================="
          echo ""
          echo "ğŸŒ Web TarayÄ±cÄ±nÄ±zdan BaÄŸlanÄ±n:"
          echo "   MasaÃ¼stÃ¼: ${{ env.CLOUDFLARE_URL }}"
          echo "   Terminal: ${{ env.CLOUDFLARE_URL }}/terminal"
          echo ""
          echo "ğŸ” VNC Åifreniz: ${{ github.event.inputs.vnc_password }}"
          echo ""
          echo "ğŸ’¡ Not: Ä°lk baÄŸlantÄ±da noVNC arayÃ¼zÃ¼nde 'Connect' butonuna basmanÄ±z gerekebilir."
          echo "   Åifre sorduÄŸunda yukarÄ±daki ÅŸifreyi girin. KullanÄ±cÄ± adÄ± boÅŸ kalabilir."
          echo ""
          echo "===================================================================="
          
      - name: 6. Oturumu AÃ§Ä±k Tut
        run: |
          echo "â° Oturum yaklaÅŸÄ±k 6 saat boyunca aÃ§Ä±k kalacak."
          echo "   Bu adÄ±mÄ± sonlandÄ±rmak iÃ§in 'Cancel workflow' butonuna basabilirsiniz."
          # Servislerin Ã§alÄ±ÅŸmaya devam etmesi iÃ§in adÄ±mÄ± bitirme
          tail -f /dev/null
