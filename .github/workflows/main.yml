name: macOS Web SSH Access (Fixed) Sonnet
on:
  workflow_dispatch:
    inputs:
      session_password:
        description: 'Web Terminal Password'
        required: false
        default: 'github2024'
        type: string

jobs:
  macos-web-ssh:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get Public IP and Setup
      run: |
        # Get public IP address
        PUBLIC_IP=$(curl -s https://ipinfo.io/ip)
        echo "ðŸŒ Public IP: $PUBLIC_IP"
        echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
        
        # Install required packages
        brew install ttyd node
        npm install -g localtunnel
        
    - name: Start Web Terminal
      run: |
        # Start ttyd web terminal
        ttyd \
          --port 8080 \
          --credential "admin:${{ github.event.inputs.session_password }}" \
          /bin/bash &
        
        echo "ðŸŒ Web terminal started on port 8080"
        sleep 5
        
    - name: Setup Public Tunnel with IP Password
      run: |
        # Start localtunnel with custom subdomain
        echo "ðŸš€ Creating public tunnel..."
        
        # Use public IP as tunnel password
        npx localtunnel --port 8080 --subdomain github-macos-$(date +%s) > tunnel.log 2>&1 &
        
        sleep 15
        
        # Extract tunnel URL
        TUNNEL_URL=$(grep -o 'https://[^[:space:]]*' tunnel.log | head -1)
        
        if [ -z "$TUNNEL_URL" ]; then
            # Fallback without subdomain
            pkill -f localtunnel
            npx localtunnel --port 8080 > tunnel.log 2>&1 &
            sleep 15
            TUNNEL_URL=$(grep -o 'https://[^[:space:]]*' tunnel.log | head -1)
        fi
        
        echo "ðŸŒ Tunnel URL: $TUNNEL_URL"
        echo "$TUNNEL_URL" > public_url.txt
        
    - name: Display Complete Access Information
      run: |
        echo "ðŸŽ‰ macOS Web Terminal is ready!"
        echo ""
        echo "ðŸ”— Access Steps:"
        echo "1. Open this URL in your browser:"
        
        if [ -f public_url.txt ]; then
            PUBLIC_URL=$(cat public_url.txt)
            echo "   $PUBLIC_URL"
            echo ""
            echo "2. ðŸ” Localtunnel Security Page:"
            echo "   Tunnel Password: $PUBLIC_IP"
            echo "   (This is the runner's public IP address)"
            echo ""
            echo "3. ðŸ–¥ï¸ Web Terminal Login:"
            echo "   Username: admin"
            echo "   Password: ${{ github.event.inputs.session_password }}"
            echo ""
            echo "4. ðŸ“± Direct Terminal Access (after tunnel auth):"
            echo "   $PUBLIC_URL/terminal"
        else
            echo "   âŒ Failed to create public tunnel"
        fi
        
        echo ""
        echo "âš¡ System Information:"
        echo "   OS: macOS $(sw_vers -productVersion)"
        echo "   Architecture: $(uname -m)"
        echo "   Public IP: $PUBLIC_IP"
        echo "   RAM: $(sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}')"
        echo "   CPU: $(sysctl -n hw.ncpu) cores"
        
    - name: Alternative: Use serveo.net (No IP required)
      run: |
        echo ""
        echo "ðŸ”„ Alternative Access Method (No IP password needed):"
        echo "Setting up serveo.net tunnel..."
        
        # Kill existing localtunnel
        pkill -f localtunnel || true
        
        # Use serveo.net as alternative
        ssh -o StrictHostKeyChecking=no -R 80:localhost:8080 serveo.net > serveo.log 2>&1 &
        
        sleep 10
        
        # Extract serveo URL
        SERVEO_URL=$(grep -o 'https://[^[:space:]]*\.serveo\.net' serveo.log | head -1)
        
        if [ ! -z "$SERVEO_URL" ]; then
            echo "ðŸŒŸ Alternative URL (No password needed): $SERVEO_URL"
            echo "ðŸ–¥ï¸ Direct terminal: $SERVEO_URL/terminal"
            echo ""
            echo "âœ… This URL works immediately without any password!"
        fi
        
    - name: Keep Session Alive
      run: |
        echo "â° Session will remain active for up to 6 hours"
        echo "ðŸ’¡ Use 'sudo shutdown -h now' to terminate early"
        echo ""
        
        while true; do
            # Keep ttyd running
            if ! pgrep ttyd > /dev/null; then
                echo "ðŸ”„ Restarting web terminal..."
                ttyd --port 8080 --credential "admin:${{ github.event.inputs.session_password }}" /bin/bash &
            fi
            
            echo "$(date): âœ… Services running - IP: $PUBLIC_IP"
            sleep 300
        done
